<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Find 1–100 (WebSocket)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, Arial, sans-serif; }
    body { margin: 0; background:#0f172a; color:#e2e8f0; display:flex; min-height:100vh; }
    .wrap { margin:auto; width:min(1000px, 96vw); }
    .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    input, button { padding:10px 12px; border-radius:8px; border:1px solid #334155; background:#0b1220; color:#e2e8f0; }
    button { cursor:pointer; }
    .grid { margin-top:14px; display:grid; grid-template-columns: repeat(10, 1fr); gap:6px; }
    .cell { background:#0b1220; border:1px solid #1f2937; border-radius:8px; padding:10px 0; text-align:center; user-select:none; }
    .cell:hover { outline:2px solid #334155; }
    .badge { padding:6px 10px; border-radius:999px; background:#0b1220; border:1px solid #334155; }
    .target { font-size:20px; font-weight:700; }
    .muted { color:#94a3b8; font-size:12px; }
    .players { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .me { border-color:#22d3ee; }
    .winner { outline:2px solid #22c55e; }
    .error { color:#fca5a5; margin-top:8px; min-height:1.2em; }
    a.share { color:#22d3ee; text-decoration:none; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <strong>Find the number</strong>
      <span class="badge">10×10 board</span>
      <span class="badge">Max 4 per lobby</span>
      <span class="badge">WebSocket only</span>
    </div>

    <div id="auth" style="margin-top:12px;">
      <div class="row">
        <input id="name" placeholder="Your name" />
        <button id="createBtn">Create lobby</button>
        <input id="code" placeholder="Lobby code" style="width:120px; text-transform:uppercase;" />
        <button id="joinBtn">Join</button>
        <button id="leaveBtn" style="display:none;">Leave</button>
      </div>
      <div class="muted" id="shareLine" style="margin-top:6px;"></div>
      <div class="error" id="err"></div>
    </div>

    <div id="game" style="display:none; margin-top:16px;">
      <div class="row">
        <div>Lobby: <span id="lobbyCode" class="badge"></span></div>
        <div>Target: <span id="target" class="badge target"></span></div>
      </div>
      <div class="players" id="players"></div>
      <div class="grid" id="grid"></div>
    </div>
  </div>
</div>

<script>
  (() => {
    const nameEl = document.getElementById('name');
    const codeEl = document.getElementById('code');
    const createBtn = document.getElementById('createBtn');
    const joinBtn = document.getElementById('joinBtn');
    const leaveBtn = document.getElementById('leaveBtn');
    const errEl = document.getElementById('err');
    const shareLine = document.getElementById('shareLine');

    const gameEl = document.getElementById('game');
    const lobbyCodeEl = document.getElementById('lobbyCode');
    const targetEl = document.getElementById('target');
    const playersEl = document.getElementById('players');
    const gridEl = document.getElementById('grid');

    // Parse ?code= from URL
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get('code')) codeEl.value = urlParams.get('code').toUpperCase();

    let ws;
    let reconnecting = false;
    let myPlayerId = localStorage.getItem('playerId') || null;
    let myLobbyCode = localStorage.getItem('lobbyCode') || null;

    function wsConnect() {
      // Use ws or wss depending on page protocol
      const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
      ws = new WebSocket(`${proto}://${location.host}`);
      ws.onopen = () => {
        err('');
        // Try auto-reconnect if we have stored player & lobby
        if (!reconnecting && myPlayerId && myLobbyCode) {
          reconnecting = true;
          ws.send(JSON.stringify({ type: "reconnect", code: myLobbyCode, playerId: myPlayerId }));
        }
      };
      ws.onmessage = (ev) => {
        const msg = JSON.parse(ev.data);
        switch (msg.type) {
          case "error":
            err(msg.message || "Error");
            break;
          case "lobby_joined":
            myPlayerId = msg.playerId;
            myLobbyCode = msg.code;
            localStorage.setItem('playerId', myPlayerId);
            localStorage.setItem('lobbyCode', myLobbyCode);
            showGame(msg.snapshot);
            shareText(msg.code);
            leaveBtn.style.display = 'inline-block';
            break;
          case "state":
            showGame(msg.snapshot);
            break;
          case "round_result":
            pulseWinner(msg.winnerPlayerId);
            showGame(msg.snapshot);
            break;
        }
      };
      ws.onclose = () => {
        // Keep UI; allow manual refresh to reconnect
      };
    }

    function err(t) { errEl.textContent = t || ''; }

    function shareText(code) {
      const link = `${location.origin}${location.pathname}?code=${code}`;
      shareLine.innerHTML = `Share code <b>${code}</b> or link <a class="share" href="${link}">${link}</a>`;
    }

    function showGame(snapshot) {
      if (!snapshot) return;
      gameEl.style.display = 'block';
      lobbyCodeEl.textContent = snapshot.code;
      targetEl.textContent = snapshot.target;

      // players
      playersEl.innerHTML = '';
      snapshot.players.forEach(p => {
        const div = document.createElement('div');
        div.className = 'badge' + (p.id === myPlayerId ? ' me' : '');
        div.textContent = `${p.name} • ${p.score}${p.connected ? '' : ' (reconnecting...)'}`;
        playersEl.appendChild(div);
      });

      // board
      gridEl.innerHTML = '';
      snapshot.board.forEach(n => {
        const btn = document.createElement('button');
        btn.className = 'cell';
        btn.textContent = n;
        btn.onclick = () => {
          if (!myLobbyCode || !myPlayerId) return;
          ws.send(JSON.stringify({ type: "guess", code: myLobbyCode, playerId: myPlayerId, number: n }));
        };
        gridEl.appendChild(btn);
      });
    }

    function pulseWinner(pid) {
      // flash winner badge briefly
      const kids = playersEl.children;
      for (const k of kids) k.classList.remove('winner');
      setTimeout(() => {
        for (const p of kids) {
          if (p.textContent.startsWith(getMyNameById(pid))) {
            p.classList.add('winner');
            setTimeout(()=>p.classList.remove('winner'), 800);
          }
        }
      }, 0);
    }

    function getMyNameById(pid) {
      // heuristic: find player's name from badge text "Name • score"
      for (const node of playersEl.children) {
        const name = node.textContent.split('•')[0].trim();
        if (node.classList.contains('me') && pid === myPlayerId) return name;
      }
      // fallback (not critical)
      return 'Winner';
    }

    // UI hooks
    createBtn.onclick = () => {
      const name = (nameEl.value || 'Player').trim();
      ws.send(JSON.stringify({ type: "create_lobby", name }));
    };
    joinBtn.onclick = () => {
      const name = (nameEl.value || 'Player').trim();
      const code = (codeEl.value || '').trim().toUpperCase();
      if (!code) { err("Enter lobby code"); return; }
      ws.send(JSON.stringify({ type: "join_lobby", code, name }));
    };
    leaveBtn.onclick = () => {
      // clear local identity and reload
      localStorage.removeItem('playerId');
      localStorage.removeItem('lobbyCode');
      location.href = location.origin + location.pathname;
    };

    // Start
    wsConnect();
  })();
</script>
</body>
</html>
