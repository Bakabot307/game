<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Terract – Tower Race</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #101826;
      --text: #e8f0ff;
      --muted: #7b8aa0;
      --accent: #7aa2ff;
      --good: #2ecc71;
      --warn: #f1c40f;
      --bad: #e74c3c;
      --grid: #142033;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #game {
      height: 100vh;
      display: grid;
      grid-template-columns: 1fr auto;
      grid-template-rows: auto 1fr;
      grid-template-areas: "header header" "board sidebar";
    }

    #authOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      z-index: 10;
    }

    #authOverlay .error {
      color: var(--bad);
      margin-top: 8px;
    }

    header {
      grid-area: header;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 14px;
      background: #0d1524;
      border-bottom: 1px solid #18243a;
    }

    header h1 {
      margin: 0;
      font-size: 16px;
      letter-spacing: .5px;
      color: var(--muted);
    }

    header .right {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    #gravity {
      color: var(--muted);
      font-size: 12px;
    }

    #status {
      font-weight: 600;
      color: var(--accent);
    }

    .wrap {
      grid-area: board;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
    }

    canvas {
      background:
        linear-gradient(0deg, transparent 19px, var(--grid) 20px),
        linear-gradient(90deg, transparent 19px, var(--grid) 20px),
        #000;
      background-size: 20px 20px, 20px 20px, contain;
      border: 1px solid #1c2a44;
      box-shadow: 0 10px 30px rgba(0, 0, 0, .35);
    }

    aside {
      grid-area: sidebar;
      width: 260px;
      background: var(--panel);
      border-left: 1px solid #18243a;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: #0e1727;
      border: 1px solid #1a2741;
      border-radius: 12px;
      padding: 12px;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .apbar {
      height: 8px;
      background: #0a1220;
      border-radius: 999px;
      overflow: hidden;
      border: 1px solid #1a2741;
    }

    .apfill {
      height: 100%;
      background: linear-gradient(90deg, #7aa2ff, #81ecec);
      width: 0%;
    }

    .players {
      display: grid;
      gap: 8px;
    }

    .p {
      display: grid;
      grid-template-columns: 16px 1fr auto;
      gap: 8px;
      align-items: center;
      font-size: 13px;
    }

    .p.turn {
      background: rgba(122, 162, 255, 0.15);
      border-radius: 6px;
      padding: 2px 4px;
    }

    .p.eliminated {
      opacity: 0.5;
      text-decoration: line-through;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .muted {
      color: var(--muted);
    }

    .powers {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .powers button {
      width: 100%;
    }

    button {
      height: 38px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid #243244;
      background: #0a1222;
      color: var(--text);
      outline: none;
      cursor: pointer;
      transition: border-color .15s ease, transform .05s ease, background .15s ease;
    }

    input {
      height: 38px;
      padding: 0 12px;
      border-radius: 10px;
      border: 1px solid #243244;
      background: #0a1222;
      color: var(--text);
      outline: none;
    }

    input:focus {
      border-color: #365072;
    }

    .btn {
      border-color: transparent;
    }

    .btn.primary {
      background: var(--accent);
    }

    .btn.success {
      background: var(--good);
    }

    button:active {
      transform: translateY(1px);
    }

    button.selected {
      background: var(--accent);
      border-color: var(--accent);
    }

    .hint {
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    @media (max-width: 760px) {
      body {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
        grid-template-areas: "header" "sidebar" "board";
      }

      aside {
        width: auto;
      }
    }
  </style>
 </head>

<body>
  <div id="authOverlay">
    <div class="card">
      <div class="row">
        <input id="name" placeholder="Your name" />
        <input id="code" placeholder="Lobby code" style="width:140px;text-transform:uppercase;" />
        <button id="createBtn" class="btn success">Create lobby</button>
        <button id="joinBtn" class="btn primary">Join</button>
      </div>
      <div class="error" id="err"></div>
    </div>
  </div>

  <div id="game" style="display:none;">
    <header>
      <h1>Terract – Tower Race</h1>
      <div class="right">
        <div id="roomCode" class="muted"></div>
        <button id="copyLinkBtn" class="btn">Copy Link</button>
        <button id="startBtn" style="display:none;">Start</button>
        <button id="restartBtn" style="display:none;">Restart</button>
        <div id="gravity" class="muted">Speed: —</div>
        <div id="status">Connecting…</div>
      </div>
    </header>

    <div class="wrap">
      <canvas id="board" width="240" height="480"></canvas>
    </div>

    <aside>
      <div class="card">
        <div class="players" id="players"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between; margin-bottom:8px;">
          <div>Power-ups</div>
          <div class="hint">Keys: 1 / 2 / 3 / 4</div>
        </div>
        <div class="powers">
          <button id="p1" title="Block Drop (2 AP)">Block Drop</button>
          <button id="p2" title="Column Bomb (3 AP)">Column Bomb</button>
          <button id="p3" title="Freeze Rival (2 AP)">Freeze</button>
          <button id="p4" title="Spare Fill (2 AP)">Fill</button>
        </div>
      </div>

      <div class="card" id="rewardCard">
        <div class="row" style="justify-content:space-between; margin-bottom:8px;">
          <div>Bonus</div>
        </div>
        <div class="powers">
          <button id="rewardExtra">+1 Turn</button>
          <button id="rewardAP">+2 AP</button>
        </div>
      </div>

      <div class="card hint">
        Controls: ← → move, Q/E rotate, ↑ rotate, ↓ soft drop, Space hard drop.
      </div>
    </aside>
  </div>

  <script>
    (() => {
        const size = 20; // px
        const canvas = document.getElementById('board');
        const ctx = canvas.getContext('2d');
        const statusEl = document.getElementById('status');
        const gravityEl = document.getElementById('gravity');
        const playersEl = document.getElementById('players');
        const startBtn = document.getElementById('startBtn');
        const restartBtn = document.getElementById('restartBtn');
        const roomCodeEl = document.getElementById('roomCode');
        const gameEl = document.getElementById('game');
        const authOverlay = document.getElementById('authOverlay');
        const nameInput = document.getElementById('name');
        const codeInput = document.getElementById('code');
        const createBtn = document.getElementById('createBtn');
        const joinBtn = document.getElementById('joinBtn');
        const errEl = document.getElementById('err');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const rewardCard = document.getElementById('rewardCard');
        const rewardExtra = document.getElementById('rewardExtra');
        const rewardAP = document.getElementById('rewardAP');
        let bonusChoice = 'ap';
        rewardAP.classList.add('selected');

        let ws = null;
        let me = null; // my id
        let width = 12, height = 24;
        let board = Array.from({ length: height }, () => Array(width).fill(null));
        let players = {};
        let currentTurn = null;
        let hostId = null;
        let currentRoom = '';
        let gameStarted = false;

        const params = new URLSearchParams(location.search);
        const urlCode = params.get('code');
        if (urlCode) codeInput.value = urlCode.toUpperCase();

        const powerButtons = {
          p1: document.getElementById('p1'),
          p2: document.getElementById('p2'),
          p3: document.getElementById('p3'),
          p4: document.getElementById('p4'),
        };
        Object.values(powerButtons).forEach(b => b.disabled = true);

        rewardExtra.onclick = () => {
          bonusChoice = 'extraTurn';
          rewardExtra.classList.add('selected');
          rewardAP.classList.remove('selected');
        };
        rewardAP.onclick = () => {
          bonusChoice = 'ap';
          rewardAP.classList.add('selected');
          rewardExtra.classList.remove('selected');
        };

        startBtn.onclick = () => send({ type: 'start', id: me });
        restartBtn.onclick = () => send({ type: 'restart', id: me });

        function startGame(roomCode, userName) {
          errEl.textContent = '';
          authOverlay.style.display = 'none';
          gameEl.style.display = 'grid';
          roomCodeEl.textContent = `Room: ${roomCode}`;
          currentRoom = roomCode;
          ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/racing?room=' + roomCode + '&name=' + encodeURIComponent(userName));
          ws.onopen = () => statusEl.textContent = 'Joined. Waiting for others…';
          ws.onclose = () => statusEl.textContent = 'Disconnected';
          ws.onmessage = (ev) => {
            const msg = JSON.parse(ev.data);
            if (msg.type === 'welcome') {
              me = msg.id; width = msg.width; height = msg.height; currentTurn = msg.turnId || null; hostId = msg.hostId;
              canvas.width = width * size; canvas.height = (height + 1) * size;
              board = Array.from({ length: height }, () => Array(width).fill(null));
            }
            if (msg.type === 'state') {
              if (msg.width && msg.height && (msg.width !== width || msg.height !== height)) {
                width = msg.width; height = msg.height;
                canvas.width = width * size; canvas.height = (height + 1) * size;
                board = Array.from({ length: height }, () => Array(width).fill(null));
              }
              board = msg.board;
              players = msg.players;
              currentTurn = msg.turnId;
              hostId = msg.hostId;
              gameStarted = msg.started;
              const mePl = players[me];
              Object.values(powerButtons).forEach(b => b.disabled = !gameStarted || mePl?.eliminated);
              renderPlayersList();
              draw();
              startBtn.style.display = hostId === me && !msg.started ? 'inline-block' : 'none';
              restartBtn.style.display = hostId === me && msg.started ? 'inline-block' : 'none';
              if (currentTurn === me) statusEl.textContent = 'Your turn';
              else if (!players[me]?.usedPower) statusEl.textContent = 'Use a power!';
              else statusEl.textContent = 'Waiting…';
            }
            if (msg.type === 'chooseReward') {
              send({ type: 'reward', id: me, choice: bonusChoice });
            }
            if (msg.type === 'event') {
              if (msg.kind === 'apGain' && msg.playerId === me) {
                statusEl.textContent = `+${msg.gain} AP → ${msg.ap}`;
                setTimeout(() => statusEl.textContent = 'Playing…', 800);
              }
              if (msg.kind === 'speedUp') {
                gravityEl.textContent = `Speed: ${Math.round(1000 / msg.gravityMs)}Hz fall`;
              }
              if (msg.kind === 'power') {
                if (msg.power === 'blockDrop') statusEl.textContent = '⚡ Junk dropped!';
                if (msg.power === 'columnBomb') statusEl.textContent = `💣 Columns ${msg.cols.join(', ')} cleared`;
                if (msg.power === 'freezeRival') statusEl.textContent = `❄️ Someone got frozen`;
                if (msg.power === 'spareFill') statusEl.textContent = '🧩 Gaps filled';
                setTimeout(() => statusEl.textContent = 'Playing…', 1000);
              }
              if (msg.kind === 'eliminated') {
                const name = msg.name || 'Player';
                statusEl.textContent = `${name} eliminated`;
                setTimeout(() => statusEl.textContent = 'Playing…', 1000);
              }
            }
            if (msg.type === 'winner') {
              const who = players[msg.winnerId]?.name || 'Player';
              statusEl.textContent = `🏆 ${who} wins!`;
            }
          };
        }

        createBtn.onclick = () => {
          const name = nameInput.value.trim();
          if (!name) { errEl.textContent = 'Enter name'; return; }
          const code = Math.random().toString(36).slice(2,8).toUpperCase();
          startGame(code, name);
        };
        joinBtn.onclick = () => {
          const name = nameInput.value.trim();
          const code = codeInput.value.trim().toUpperCase();
          if (!name || !code) { errEl.textContent = 'Enter name and code'; return; }
          startGame(code, name);
        };

        copyLinkBtn.onclick = () => {
          const link = `${location.origin}${location.pathname}?code=${currentRoom}`;
          navigator.clipboard.writeText(link);
          copyLinkBtn.textContent = 'Copied!';
          setTimeout(() => copyLinkBtn.textContent = 'Copy Link', 1500);
        };

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#7b8aa0';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        for (let x = 0; x < width; x++) {
          ctx.fillText(x, x * size + size / 2, 12);
        }
        // settled
        for (let y = 0; y < board.length; y++) {
          for (let x = 0; x < board[y].length; x++) {
            const c = board[y][x];
            if (c) {
              ctx.fillStyle = c;
              ctx.fillRect(x * size, (y + 1) * size, size, size);
              ctx.strokeStyle = '#142033';
              ctx.lineWidth = 1;
              ctx.strokeRect(x * size + 0.5, (y + 1) * size + 0.5, size - 1, size - 1);
            }
          }
        }
        // actives
        Object.values(players).forEach(p => {
          if (!p.active) return;
          const mat = getShape(p.active.kind, p.active.rot);
          ctx.fillStyle = p.color;
          for (let r = 0; r < mat.length; r++) {
            for (let c = 0; c < mat[r].length; c++) {
              if (mat[r][c]) {
                const x = (p.active.x + c) * size;
                const y = (p.active.y + r + 1) * size;
                ctx.fillRect(x, y, size, size);
                ctx.strokeStyle = '#142033';
                ctx.lineWidth = 1;
                ctx.strokeRect(x + 0.5, y + 0.5, size - 1, size - 1);
              }
            }
          }
        });
      }

      function getShape(kind, rot) {
        const SHAPES = {
          I: [
            [[1, 1, 1, 1]],
            [[1], [1], [1], [1]]
          ],
          O: [
            [[1, 1], [1, 1]]
          ],
          T: [
            [[1, 1, 1], [0, 1, 0]],
            [[0, 1], [1, 1], [0, 1]],
            [[0, 1, 0], [1, 1, 1]],
            [[1, 0], [1, 1], [1, 0]]
          ],
          J: [
            [[1, 0, 0], [1, 1, 1]],
            [[1, 1], [1, 0], [1, 0]],
            [[1, 1, 1], [0, 0, 1]],
            [[0, 1], [0, 1], [1, 1]]
          ],
          L: [
            [[0, 0, 1], [1, 1, 1]],
            [[1, 0], [1, 0], [1, 1]],
            [[1, 1, 1], [1, 0, 0]],
            [[1, 1], [0, 1], [0, 1]]
          ],
          S: [
            [[0, 1, 1], [1, 1, 0]],
            [[1, 0], [1, 1], [0, 1]]
          ],
          Z: [
            [[1, 1, 0], [0, 1, 1]],
            [[0, 1], [1, 1], [1, 0]]
          ]
        };
        const forms = SHAPES[kind];
        return forms[Math.min(rot, forms.length - 1)];
      }

      function renderPlayersList() {
        const meId = me;
        playersEl.innerHTML = '';
        Object.values(players).forEach(p => {
          const row = document.createElement('div');
          row.className = 'p' + (p.id === currentTurn ? ' turn' : '') + (p.eliminated ? ' eliminated' : '');
          const dot = document.createElement('div');
          dot.className = 'dot';
          dot.style.background = p.color;
          const name = document.createElement('div');
          name.textContent = (p.id === meId ? 'You' : p.name) + (p.eliminated ? ' (Eliminated)' : '');
          const ap = document.createElement('div');
          ap.style.width = '90px';
          ap.innerHTML = `
            <div class="apbar"><div class="apfill" style="width:${Math.round((p.ap / 10) * 100)}%"></div></div>
            <div class="muted" style="text-align:right;">${p.ap} AP</div>
          `;
          row.append(dot, name, ap);

          if (!p.eliminated && p.frozenUntil && Date.now() < p.frozenUntil) {
            row.title = 'Frozen';
            row.style.opacity = .7;
          }
          playersEl.appendChild(row);
        });
      }

      function send(msg) {
        try { ws.send(JSON.stringify(msg)); } catch { }
      }

      const keymap = {
        ArrowLeft: 'left',
        ArrowRight: 'right',
        ArrowDown: 'soft',
        Space: 'hard',
        ArrowUp: 'rotCW',
        KeyQ: 'rotCCW',
        KeyE: 'rotCW',
        Digit1: 'p1',
        Digit2: 'p2',
        Digit3: 'p3',
        Digit4: 'p4',
      };

      document.addEventListener('keydown', (e) => {
        if (!gameStarted) return;
        const act = keymap[e.code];
        if (!act) return;
        e.preventDefault();
        const mePl = players[me];
        if (!mePl || mePl.eliminated) return;
        if (act === 'p1') {
          if (currentTurn === me) return;
          if (mePl.usedPower) return;
          send({ type: 'power', id: me, kind: 'blockDrop' });
        } else if (act === 'p2') {
          if (currentTurn === me) return;
          if (mePl.usedPower) return;
          const col = Math.floor(Math.random() * width);
          send({ type: 'power', id: me, kind: 'columnBomb', col });
        } else if (act === 'p3') {
          if (currentTurn === me) return;
          if (mePl.usedPower) return;
          send({ type: 'power', id: me, kind: 'freezeRival' });
        } else if (act === 'p4') {
          if (currentTurn === me) return;
          if (mePl.usedPower) return;
          send({ type: 'power', id: me, kind: 'spareFill' });
        } else {
          if (currentTurn !== me) return;
          send({ type: 'move', id: me, dir: act });
        }
      });

      powerButtons.p1.onclick = () => {
        if (!gameStarted) return;
        const mePl = players[me];
        if (!mePl || mePl.eliminated) return;
        if (currentTurn !== me && !mePl.usedPower) send({ type: 'power', id: me, kind: 'blockDrop' });
      };
      powerButtons.p2.onclick = () => {
        if (!gameStarted) return;
        const mePl = players[me];
        if (!mePl || mePl.eliminated) return;
        if (currentTurn === me || mePl.usedPower) return;
        const col = prompt(`Column (0-${width - 1})?`, Math.floor(width / 2).toString());
        const cNum = Math.max(0, Math.min(width - 1, parseInt(col || Math.floor(width / 2), 10)));
        send({ type: 'power', id: me, kind: 'columnBomb', col: cNum });
      };
      powerButtons.p3.onclick = () => {
        if (!gameStarted) return;
        const mePl = players[me];
        if (!mePl || mePl.eliminated) return;
        if (currentTurn !== me && !mePl.usedPower) send({ type: 'power', id: me, kind: 'freezeRival' });
      };
      powerButtons.p4.onclick = () => {
        if (!gameStarted) return;
        const mePl = players[me];
        if (!mePl || mePl.eliminated) return;
        if (currentTurn !== me && !mePl.usedPower) send({ type: 'power', id: me, kind: 'spareFill' });
      };

    })();
  </script>
</body>

</html>